<!doctype html><html><head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge"><title>my-first-post - AshF0x</title><link rel=icon type=image/png href=/favicon.ico><meta name=viewport content="width=device-width,initial-scale=1">
<meta name=description content="Gamer R TL;DR Reverse a Unity game and patch it to get the flag
Description This challenge was the last Reversing challenge for TJCTF and gave 80 points. The challenge provided you with a folder that contained a binary as well as several Unity related files and libraries. The game itself was pretty simple. All you had to do was hit space to shoot a knife and hit an orange, all while trying to avoid hitting the ducks swimming randomly in between.">
<meta property="og:image" content>
<meta property="og:title" content="my-first-post">
<meta property="og:description" content="Gamer R TL;DR Reverse a Unity game and patch it to get the flag
Description This challenge was the last Reversing challenge for TJCTF and gave 80 points. The challenge provided you with a folder that contained a binary as well as several Unity related files and libraries. The game itself was pretty simple. All you had to do was hit space to shoot a knife and hit an orange, all while trying to avoid hitting the ducks swimming randomly in between.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://ashf0x.com/posts/my-first-post/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2021-11-27T12:29:41+01:00">
<meta property="article:modified_time" content="2021-11-27T12:29:41+01:00">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="my-first-post">
<meta name=twitter:description content="Gamer R TL;DR Reverse a Unity game and patch it to get the flag
Description This challenge was the last Reversing challenge for TJCTF and gave 80 points. The challenge provided you with a folder that contained a binary as well as several Unity related files and libraries. The game itself was pretty simple. All you had to do was hit space to shoot a knife and hit an orange, all while trying to avoid hitting the ducks swimming randomly in between.">
<script src=https://ashf0x.com/js/feather.min.js></script>
<link href=https://ashf0x.com/css/fonts.b685ac6f654695232de7b82a9143a46f9e049c8e3af3a21d9737b01f4be211d1.css rel=stylesheet>
<link rel=stylesheet type=text/css media=screen href=https://ashf0x.com/css/main.2f9b5946627215dc1ae7fa5f82bfc9cfcab000329136befeea5733f21e77d68f.css>
<link id=darkModeStyle rel=stylesheet type=text/css href=https://ashf0x.com/css/dark.726cd11ca6eb7c4f7d48eb420354f814e5c1b94281aaf8fd0511c1319f7f78a4.css disabled>
</head>
<body>
<div class=content><header>
<div class=main>
<a href=https://ashf0x.com/>AshF0x</a>
</div>
<nav>
<a href=/>Home</a>
<a href=/posts>All posts</a>
| <a id=dark-mode-toggle onclick=toggleTheme() href></a>
<script src=https://ashf0x.com/js/themetoggle.js></script>
</nav>
</header>
<main>
<article>
<div class=title>
<h1 class=title>my-first-post</h1>
<div class=meta>Posted on Nov 27, 2021</div>
</div>
<section class=body>
<h1 id=gamer-r>Gamer R</h1>
<h2 id=tldr>TL;DR</h2>
<p>Reverse a Unity game and patch it to get the flag</p>
<h2 id=description>Description</h2>
<p>This challenge was the last Reversing challenge for TJCTF and gave 80 points. The challenge provided you with a folder that contained a binary as well as several Unity related files and libraries. The game itself was pretty simple. All you had to do was hit space to shoot a knife and hit an orange, all while trying to avoid hitting the ducks swimming randomly in between.
If you manage to hit the orange, your score gets increased by 1.</p>
<p><img src=/images/car.jpg alt=game></p>
<p>When hitting a duck, your score gets reset to zero,</p>
<p><img src=img/gameover.gif alt=gameover></p>
<p>which means that we probably need to reach a certain score to get the flag. Unity games are normally written in C# which is an interpreted language that generates a bytecode instead of machine code which means that we can easily decompile it. I&rsquo;ll use dnSpy to decompile the program.</p>
<h2 id=reversing>Reversing</h2>
<p>Unity stores the game logic in <em>Projectname</em>_Data/Managed/Assembly-CSharp.dll so let&rsquo;s open it in dnSpy</p>
<p><img src=img/dnSpy.png alt=dnSpy></p>
<p>Let&rsquo;s try to make the game easier by changing the duck collision behaviour described in the class DuckCollisionSystem.
The important part of the code looks like this:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=color:#66d9ef>if</span>  (Vector2.Distance(<span style=color:#66d9ef>this</span>.ducks.Transforms[i].position,  <span style=color:#66d9ef>this</span>.knife.Transforms[j].position)  &lt;  <span style=color:#66d9ef>this</span>.hitBoxRadius)
{
	...
	collision()
	...
}
<span style=color:#66d9ef>private</span>  <span style=color:#66d9ef>float</span>  hitBoxRadius  =  <span style=color:#ae81ff>0.6f</span>;
</code></pre></div><p>The code basically checks if the distance between a duck and the knife is smaller than the specified hitbox radius. If yes, a collision is detected. We can easily bypass this check by changing the value of the hitBoxRadius variable</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=color:#66d9ef>private</span>  <span style=color:#66d9ef>float</span>  hitBoxRadius  =  -<span style=color:#ae81ff>1.0f</span>;
</code></pre></div><p>test
After recompiling the code, we can now shoot as many knives as we want without hitting any duck. While I was playing the patched version, I noticed that the score showed a letter instead of a number every multiple of 20, so I played a while to see if the flag would show up.</p>
<p><img src=img/hacked.gif alt=patched></p>
<p>The issue however was that the encoded text was really long and it took me ages to reach each character. So I decided to take a look at the KnifeMoveSystem class which also dealt with increasing the score</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=color:#66d9ef>if</span>  (<span style=color:#66d9ef>this</span>.knife.Transforms[i].position.y  &gt;  <span style=color:#ae81ff>4f</span>)  
{  
	...
	<span style=color:#66d9ef>this</span>.score.ScoreComponents[k].Score++;  
	<span style=color:#66d9ef>this</span>.score.ScoreComponents[k].CumScore  += (<span style=color:#66d9ef>double</span>)<span style=color:#66d9ef>this</span>.score.ScoreComponents[k].Score;
	...
}
</code></pre></div><p>The code checked if a knife had reached the orange and increased the score by one and the CumScore by score. I decided to try and change the value by which Score is increased to 20 and recompiled the code</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=color:#66d9ef>this</span>.score.ScoreComponents[k].Score += <span style=color:#ae81ff>20</span>;  
</code></pre></div><p>However this led to an issue and the characters didn&rsquo;t show up right</p>
<p><img src=img/problem.gif alt=bug></p>
<p>So I took a look inside the scoreUpdateSystem class to see what the problem was about</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=color:#66d9ef>if</span>  (<span style=color:#66d9ef>this</span>.text.ScoreComponents[i].Score  /  <span style=color:#ae81ff>20</span>  &lt;  <span style=color:#66d9ef>this</span>.text.ScoreComponents[i].TextSeq.Length  &amp;&amp;  <span style=color:#66d9ef>this</span>.text.ScoreComponents[i].Score  %  <span style=color:#ae81ff>20</span>  ==  <span style=color:#ae81ff>0</span>)  
{  
	<span style=color:#66d9ef>this</span>.text.Texts[i].text  =  ((<span style=color:#66d9ef>char</span>)(<span style=color:#66d9ef>this</span>.text.ScoreComponents[i].TextSeq[<span style=color:#66d9ef>this</span>.text.ScoreComponents[i].Score  /  <span style=color:#ae81ff>20</span>]  ^  (<span style=color:#66d9ef>int</span>)(<span style=color:#66d9ef>this</span>.text.ScoreComponents[i].CumScore  %  <span style=color:#ae81ff>4096.0</span>))).ToString();  
}
</code></pre></div><p>This part checked whether the score was divisible by 20 and if so, it xored a value in the TextSeq array with the CumScore value and put the result into the UI score field. That meant that I had to fix the cumScore value as well when I increased the score by 20 as the cumScore would have normally increased by every integer between 0 and 20. A quick way to do this is to use the formula to calculate a triangular number which basically sums up to :
cumScore = ((score)*(score+1))/2
Implemented in C# this gives us:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=color:#66d9ef>this</span>.score.ScoreComponents[k].CumScore  =  (<span style=color:#66d9ef>double</span>)<span style=color:#66d9ef>this</span>.score.ScoreComponents[k].Score  *  ((<span style=color:#66d9ef>double</span>)<span style=color:#66d9ef>this</span>.score.ScoreComponents[k].Score  +  <span style=color:#ae81ff>1.0</span>)  /  <span style=color:#ae81ff>2.0</span>;
</code></pre></div><p>Recompiling the game gives us a working patch that gets us the flag way faster</p>
<p><img src=img/solution.gif alt=solution></p>
<p>The letters found in the score field build up following text:
HERE&rsquo;S THE FLAG YOU&rsquo;RE LOOKING FOR! HAHA JKJK&mldr; UNLESS&mldr;? TJCTF{ORENJI_MANGGOE}
and we have our flag</p>
</section>
<div class=post-tags>
</div>
</article>
</main>
<footer>
<hr><a class=soc href=https://github.com/ashf0x title=GitHub><i data-feather=github></i></a>|<a class=soc href=https://twitter.com/0xAshFox title=Twitter><i data-feather=twitter></i></a>|⚡️
2021 <a href=https://github.com/athul/archie>Archie Theme</a> | Built with <a href=https://gohugo.io>Hugo</a>
</footer>
<script>feather.replace()</script></div>
</body>
</html>